<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Market</title>
  <link rel="stylesheet" href="/assets/style.css" /></head>
<body>
<header>
  <h1>Game Market</h1>
</header>

<main>
  <section class="card" aria-labelledby="tbl-heading">
    <h2 id="tbl-heading">Ігри на продаж</h2>
    <div class="content">
      <div class="toolbar">
        <button class="btn-primary" id="refreshBtn">Оновити</button>
        <span class="pill" id="countLabel">0 записів</span>
        <span class="muted">Клік по рядку — редагувати</span>
      </div>
      <div style="overflow:auto">
        <table id="gamesTable" aria-describedby="tbl-heading">
          <thead>
            <tr>
              <th>ID</th>
              <th>Назва</th>
              <th>Платформа</th>
              <th>Ціна, $</th>
              <th>Продавець</th>
              <th>Дії</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="footer">
      <span class="muted"></span>
      <div>
        <button class="btn-warn" id="clearFormBtn">Очистити форму</button>
      </div>
    </div>
  </section>

  <section class="card" aria-labelledby="form-heading">
    <h2 id="form-heading">Форма</h2>
    <div class="content">
      <form id="gameForm">
        <input type="hidden" id="id" />
        <div class="grid">
          <div class="row">
            <label for="title">Назва</label>
            <input id="title" required placeholder="The Witcher 3" />
          </div>
          <div class="row">
            <label for="platform">Платформа</label>
            <select id="platform" required>
              <option value="">— Оберіть —</option>
              <option>PC</option>
              <option>PlayStation</option>
              <option>Xbox</option>
              <option>Nintendo</option>
              <option>Mobile</option>
            </select>
          </div>
          <div class="row">
            <label for="price">Ціна</label>
            <input id="price" type="number" min="0" step="0.01" placeholder="19.99" required />
          </div>
          <div class="row">
            <label for="seller">Продавець</label>
            <input id="seller" placeholder="Ivan" />
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="actions">
          <button type="submit" class="btn-green" id="createBtn">Створити</button>
          <button type="button" id="updateBtn">Оновити</button>
          <button type="button" class="btn-danger" id="deleteBtn">Видалити</button>
        </div>
      </form>
    </div>
  </section>
</main>

<script>
  const API = '/api/games';
  const $ = (id) => document.getElementById(id);

  function setForm(game){
    $('id').value = game?.id ?? '';
    $('title').value = game?.title ?? '';
    $('platform').value = game?.platform ?? '';
    $('price').value = game?.price ?? '';
    $('seller').value = game?.seller ?? '';
  }

  function getForm(){
    return {
      id: $('id').value ? Number($('id').value) : undefined,
      title: $('title').value.trim(),
      platform: $('platform').value,
      price: Number($('price').value || 0),
      seller: $('seller').value.trim()
    }
  }

  async function fetchJSON(url, opts){
    const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...opts });
    if(!res.ok){
      const msg = await res.text();
      throw new Error(msg || (res.status + ' ' + res.statusText));
    }
    if(res.status === 204) return null;
    return res.json();
  }

  function renderRows(items){
    const tbody = document.querySelector('#gamesTable tbody');
    tbody.innerHTML = '';
    items.forEach(g => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${g.id}</td>
        <td>${escapeHtml(g.title)}</td>
        <td>${escapeHtml(g.platform)}</td>
        <td>${Number(g.price).toFixed(2)}</td>
        <td>${escapeHtml(g.seller ?? '')}</td>
        <td>
          <div class="actions">
            <button data-act="edit">Edit</button>
            <button class="btn-danger" data-act="del">Del</button>
          </div>
        </td>`;
      tr.addEventListener('click', (e) => {
        const act = e.target?.dataset?.act;
        if(act === 'edit'){ setForm(g); }
        if(act === 'del'){ doDelete(g.id); }
      });
      tbody.appendChild(tr);
    });
    $('countLabel').textContent = items.length + ' записів';
  }

  function escapeHtml(str){
    return String(str ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  async function load(){
    const data = await fetchJSON(API);
    renderRows(data);
  }

  async function doCreate(){
    const g = getForm();
    const created = await fetchJSON(API, { method:'POST', body: JSON.stringify(g) });
    setForm(created);
    await load();
  }

  async function doUpdate(){
    const g = getForm();
    if(!g.id){ alert('Спочатку оберіть рядок для редагування'); return; }
    const updated = await fetchJSON(`${API}/${g.id}`, { method:'PUT', body: JSON.stringify(g) });
    setForm(updated);
    await load();
  }

  async function doDelete(id){
    const targetId = id ?? getForm().id;
    if(!targetId){ alert('Немає ID для видалення'); return; }
    if(!confirm('Видалити запис #' + targetId + '?')) return;
    await fetchJSON(`${API}/${targetId}`, { method:'DELETE' });
    setForm({});
    await load();
  }

  $('gameForm').addEventListener('submit', (e)=>{ e.preventDefault(); doCreate().catch(err => alert(err.message)); });
  $('updateBtn').addEventListener('click', ()=> doUpdate().catch(err => alert(err.message)));
  $('deleteBtn').addEventListener('click', ()=> doDelete().catch(err => alert(err.message)));
  $('clearFormBtn').addEventListener('click', ()=> setForm({}));
  $('refreshBtn').addEventListener('click', ()=> load().catch(err => alert(err.message)));

  load().catch(err => alert(err.message));
</script>
</body>
</html>

